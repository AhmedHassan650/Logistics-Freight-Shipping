<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Management - CYMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://cdn.datatables.net/2.1.7/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            margin: 0;
            font-family: 'Arial', sans-serif;
        }
        .navbar {
            background-color: #343a40;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1100;
        }
        .sidebar {
            height: calc(100vh - 56px);
            position: fixed;
            top: 56px;
            left: 0;
            width: 200px;
            background-color: #2c3e50;
            padding-top: 20px;
            z-index: 1000;
            animation: slideIn 0.5s ease-out;
        }
        .sidebar a {
            color: white;
            padding: 15px 20px;
            text-decoration: none;
            display: block;
            transition: background-color 0.3s;
        }
        .sidebar a:hover {
            background-color: #34495e;
        }
        .content {
            margin-left: 200px;
            padding: 20px;
            animation: fadeIn 0.8s ease-out;
        }
        .chart-container, .table-container {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            animation: fadeIn 0.8s ease-out;
        }
        .filter-container {
            margin-bottom: 15px;
        }
        .btn-export {
            transition: transform 0.2s;
        }
        .btn-export:hover {
            transform: scale(1.1);
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        @media print {
            .navbar, .sidebar, .nav-tabs, .no-print {
                display: none;
            }
            .content {
                margin-left: 0;
            }
            .tab-content > .tab-pane {
                display: block !important;
                opacity: 1 !important;
            }
        }
        @media (max-width: 768px) {
            .sidebar {
                left: -200px;
                transition: left 0.3s ease;
            }
            .sidebar.active {
                left: 0;
            }
            .content {
                margin-left: 0;
                transition: margin-left 0.3s ease;
            }
            .content.active {
                margin-left: 200px;
            }
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.datatables.net/2.1.7/js/dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/2.1.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
    <script>
        function logout() {
            localStorage.removeItem('loggedIn');
            window.location.href = 'login.html';
        }
        function checkLogin() {
            if (!localStorage.getItem('loggedIn')) {
                window.location.href = 'login.html';
            }
        }
        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('active');
            document.querySelector('.content').classList.toggle('active');
        }
        function getTransactions() {
            let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
            return transactions.sort((a, b) => new Date(a.date) - new Date(b.date));
        }
        function populateFilters() {
            let containers = JSON.parse(localStorage.getItem('containers')) || [];
            let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
            let types = [...new Set(containers.map(c => c.type))];
            let customers = [...new Set(transactions.map(t => t.customer))];
            let locations = [...new Set(containers.map(c => c.shippingDetails.to))];
            let typeSelect = document.getElementById('typeFilter');
            typeSelect.innerHTML = '<option value="">All Types</option>';
            types.forEach(type => {
                let option = document.createElement('option');
                option.value = type;
                option.text = type;
                typeSelect.appendChild(option);
            });
            let typeSelectLedger = document.getElementById('typeFilterLedger');
            typeSelectLedger.innerHTML = '<option value="">All Types</option>';
            types.forEach(type => {
                let option = document.createElement('option');
                option.value = type;
                option.text = type;
                typeSelectLedger.appendChild(option);
            });
            let customerSelect = document.getElementById('customerFilter');
            customerSelect.innerHTML = '<option value="">All Customers</option>';
            customers.forEach(customer => {
                let option = document.createElement('option');
                option.value = customer;
                option.text = customer;
                customerSelect.appendChild(option);
            });
            let locationSelect = document.getElementById('locationFilter');
            locationSelect.innerHTML = '<option value="">All Locations</option>';
            locations.forEach(location => {
                let option = document.createElement('option');
                option.value = location;
                option.text = location;
                locationSelect.appendChild(option);
            });
        }
        function applyFilters(startDate, endDate, customer, location, type) {
            let transactions = getTransactions();
            let containers = JSON.parse(localStorage.getItem('containers')) || [];
            if (startDate && endDate) {
                transactions = transactions.filter(t => {
                    const date = new Date(t.date);
                    return date >= startDate && date <= endDate;
                });
            }
            if (customer) {
                transactions = transactions.filter(t => t.customer === customer);
            }
            if (location) {
                transactions = transactions.filter(t => {
                    let container = containers.find(c => c.serialNo === t.serialNo);
                    return container && container.shippingDetails.to === location;
                });
            }
            if (type) {
                transactions = transactions.filter(t => {
                    let container = containers.find(c => c.serialNo === t.serialNo);
                    return container && container.type === type;
                });
            }
            return { transactions, containers };
        }
        function displayTransactions(startDate, endDate, customer, location, type) {
            let { transactions } = applyFilters(startDate, endDate, customer, location, type);
            let table = document.getElementById('transactionTable');
            let tbody = table.getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';
            let total = 0;
            transactions.forEach(t => {
                let row = tbody.insertRow();
                row.insertCell().innerText = t.type;
                row.insertCell().innerText = t.serialNo;
                row.insertCell().innerText = t.customer;
                row.insertCell().innerText = t.amount.toFixed(2);
                row.insertCell().innerText = new Date(t.date).toLocaleDateString();
                total += t.amount;
            });
            document.getElementById('totalRevenue').innerText = total.toFixed(2);
            if ($.fn.DataTable.isDataTable('#transactionTable')) {
                $('#transactionTable').DataTable().destroy();
            }
            $('#transactionTable').DataTable({
                responsive: true,
                pageLength: 10,
                order: [[4, 'desc']],
                columnDefs: [{ targets: '_all', searchable: true, orderable: true }]
            });
        }
        function displayLedger(startDate, endDate, customer, location, type) {
            let { transactions } = applyFilters(startDate, endDate, customer, location, type);
            let table = document.getElementById('ledgerTable');
            let tbody = table.getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';
            let runningBalance = 0;
            transactions.forEach(t => {
                runningBalance += t.amount;
                let row = tbody.insertRow();
                row.insertCell().innerText = new Date(t.date).toLocaleDateString();
                row.insertCell().innerText = t.type;
                row.insertCell().innerText = t.serialNo;
                row.insertCell().innerText = t.customer;
                row.insertCell().innerText = t.amount.toFixed(2);
                row.insertCell().innerText = runningBalance.toFixed(2);
            });
            if ($.fn.DataTable.isDataTable('#ledgerTable')) {
                $('#ledgerTable').DataTable().destroy();
            }
            $('#ledgerTable').DataTable({
                responsive: true,
                pageLength: 10,
                order: [[0, 'desc']],
                columnDefs: [{ targets: '_all', searchable: true, orderable: true }]
            });
        }
        function displayMonthlyReport(startDate, endDate, customer, location, type) {
            let { transactions } = applyFilters(startDate, endDate, customer, location, type);
            let monthlyMap = {};
            transactions.forEach(t => {
                let month = new Date(t.date).toLocaleString('default', { month: 'long', year: 'numeric' });
                monthlyMap[month] = (monthlyMap[month] || 0) + t.amount;
            });
            let table = document.getElementById('monthlyTable');
            let tbody = table.getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';
            for (let month in monthlyMap) {
                let row = tbody.insertRow();
                row.insertCell().innerText = month;
                row.insertCell().innerText = monthlyMap[month].toFixed(2);
            }
            if ($.fn.DataTable.isDataTable('#monthlyTable')) {
                $('#monthlyTable').DataTable().destroy();
            }
            $('#monthlyTable').DataTable({
                responsive: true,
                pageLength: 10,
                order: [[0, 'desc']],
                columnDefs: [{ targets: '_all', searchable: true, orderable: true }]
            });
        }
        function displayQuarterlyReport(startDate, endDate, customer, location, type) {
            let { transactions } = applyFilters(startDate, endDate, customer, location, type);
            let quarterlyMap = {};
            transactions.forEach(t => {
                let date = new Date(t.date);
                let quarter = `Q${Math.floor((date.getMonth() + 3) / 3)} ${date.getFullYear()}`;
                quarterlyMap[quarter] = (quarterlyMap[quarter] || 0) + t.amount;
            });
            let table = document.getElementById('quarterlyTable');
            let tbody = table.getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';
            for (let quarter in quarterlyMap) {
                let row = tbody.insertRow();
                row.insertCell().innerText = quarter;
                row.insertCell().innerText = quarterlyMap[quarter].toFixed(2);
            }
            if ($.fn.DataTable.isDataTable('#quarterlyTable')) {
                $('#quarterlyTable').DataTable().destroy();
            }
            $('#quarterlyTable').DataTable({
                responsive: true,
                pageLength: 10,
                order: [[0, 'desc']],
                columnDefs: [{ targets: '_all', searchable: true, orderable: true }]
            });
        }
        function displayRevenueByType(startDate, endDate, customer, location) {
            let { transactions, containers } = applyFilters(startDate, endDate, customer, location);
            let typeMap = {};
            transactions.forEach(t => {
                let container = containers.find(c => c.serialNo === t.serialNo);
                if (container) {
                    typeMap[container.type] = (typeMap[container.type] || 0) + t.amount;
                }
            });
            new Chart(document.getElementById('revenueByTypeChart'), {
                type: 'pie',
                data: {
                    labels: Object.keys(typeMap),
                    datasets: [{ data: Object.values(typeMap), backgroundColor: ['#36a2eb', '#ff6384', '#4bc0c0', '#ffce56', '#9966ff'] }]
                },
                options: { responsive: true, plugins: { legend: { position: 'top' } } }
            });
        }
        function displayRevenueByCustomer(startDate, endDate, customer, location) {
            let { transactions } = applyFilters(startDate, endDate, customer, location);
            let customerMap = {};
            transactions.forEach(t => {
                customerMap[t.customer] = (customerMap[t.customer] || 0) + t.amount;
            });
            new Chart(document.getElementById('revenueByCustomerChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(customerMap),
                    datasets: [{ label: 'Revenue by Customer', data: Object.values(customerMap), backgroundColor: '#ffce56' }]
                },
                options: { indexAxis: 'y', responsive: true, scales: { x: { beginAtZero: true } } }
            });
        }
        function exportTableToCSV(tableId, filename) {
            let table = document.getElementById(tableId);
            let rows = Array.from(table.querySelectorAll('tr'));
            let csv = rows.map(row => {
                let cols = Array.from(row.querySelectorAll('th, td')).map(col => `"${col.innerText.replace(/"/g, '""')}"`);
                return cols.join(',');
            }).join('\n');
            let blob = new Blob([csv], { type: 'text/csv' });
            let link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }
        function printCurrentTab() {
            window.print();
        }
        window.onload = function() {
            checkLogin();
            populateFilters();
            flatpickr('#dateRange', {
                mode: 'range',
                dateFormat: 'Y-m-d',
                onChange: function(selectedDates) {
                    let startDate = selectedDates[0] ? new Date(selectedDates[0]) : null;
                    let endDate = selectedDates[1] ? new Date(selectedDates[1]) : null;
                    let customer = document.getElementById('customerFilter').value;
                    let location = document.getElementById('locationFilter').value;
                    let type = document.getElementById('typeFilter').value;
                    displayTransactions(startDate, endDate, customer, location, type);
                    displayLedger(startDate, endDate, customer, location, type);
                    displayMonthlyReport(startDate, endDate, customer, location, type);
                    displayQuarterlyReport(startDate, endDate, customer, location, type);
                    displayRevenueByType(startDate, endDate, customer, location);
                    displayRevenueByCustomer(startDate, endDate, customer, location);
                }
            });
            document.getElementById('customerFilter').addEventListener('change', function() {
                let startDate = flatpickr('#dateRange').selectedDates[0] ? new Date(flatpickr('#dateRange').selectedDates[0]) : null;
                let endDate = flatpickr('#dateRange').selectedDates[1] ? new Date(flatpickr('#dateRange').selectedDates[1]) : null;
                let customer = this.value;
                let location = document.getElementById('locationFilter').value;
                let type = document.getElementById('typeFilter').value;
                displayTransactions(startDate, endDate, customer, location, type);
                displayLedger(startDate, endDate, customer, location, type);
                displayMonthlyReport(startDate, endDate, customer, location, type);
                displayQuarterlyReport(startDate, endDate, customer, location, type);
                displayRevenueByType(startDate, endDate, customer, location);
                displayRevenueByCustomer(startDate, endDate, customer, location);
            });
            document.getElementById('locationFilter').addEventListener('change', function() {
                let startDate = flatpickr('#dateRange').selectedDates[0] ? new Date(flatpickr('#dateRange').selectedDates[0]) : null;
                let endDate = flatpickr('#dateRange').selectedDates[1] ? new Date(flatpickr('#dateRange').selectedDates[1]) : null;
                let customer = document.getElementById('customerFilter').value;
                let location = this.value;
                let type = document.getElementById('typeFilter').value;
                displayTransactions(startDate, endDate, customer, location, type);
                displayLedger(startDate, endDate, customer, location, type);
                displayMonthlyReport(startDate, endDate, customer, location, type);
                displayQuarterlyReport(startDate, endDate, customer, location, type);
                displayRevenueByType(startDate, endDate, customer, location);
                displayRevenueByCustomer(startDate, endDate, customer, location);
            });
            document.getElementById('typeFilter').addEventListener('change', function() {
                let startDate = flatpickr('#dateRange').selectedDates[0] ? new Date(flatpickr('#dateRange').selectedDates[0]) : null;
                let endDate = flatpickr('#dateRange').selectedDates[1] ? new Date(flatpickr('#dateRange').selectedDates[1]) : null;
                let customer = document.getElementById('customerFilter').value;
                let location = document.getElementById('locationFilter').value;
                let type = this.value;
                displayTransactions(startDate, endDate, customer, location, type);
                displayLedger(startDate, endDate, customer, location, type);
                displayMonthlyReport(startDate, endDate, customer, location, type);
                displayQuarterlyReport(startDate, endDate, customer, location, type);
                displayRevenueByType(startDate, endDate, customer, location);
                displayRevenueByCustomer(startDate, endDate, customer, location);
            });
            document.getElementById('typeFilterLedger').addEventListener('change', function() {
                let startDate = flatpickr('#dateRange').selectedDates[0] ? new Date(flatpickr('#dateRange').selectedDates[0]) : null;
                let endDate = flatpickr('#dateRange').selectedDates[1] ? new Date(flatpickr('#dateRange').selectedDates[1]) : null;
                let customer = document.getElementById('customerFilter').value;
                let location = document.getElementById('locationFilter').value;
                let type = this.value;
                displayLedger(startDate, endDate, customer, location, type);
            });
            displayTransactions();
            displayLedger();
            displayMonthlyReport();
            displayQuarterlyReport();
            displayRevenueByType();
            displayRevenueByCustomer();
        };
    </script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">CYMS</a>
            <button class="navbar-toggler no-print" type="button" onclick="toggleSidebar()">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>
    <div class="sidebar">
        <a href="index.html">Dashboard</a>
        <a href="container_management.html">Containers</a>
        <a href="rental_management.html">Rentals</a>
        <a href="shipping_management.html">Shipping</a>
        <a href="financial_management.html">Finance</a>
        <a href="reports.html">Reports</a>
        <a href="#" onclick="logout()">Logout</a>
    </div>
    <div class="content">
        <h1 class="mb-4">Financial Reports <button class="btn btn-secondary btn-sm btn-export no-print" onclick="printCurrentTab()">Print Current Report</button></h1>
        <ul class="nav nav-tabs no-print" id="financialTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="transactions-tab" data-bs-toggle="tab" data-bs-target="#transactions" type="button" role="tab">Transactions</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="ledger-tab" data-bs-toggle="tab" data-bs-target="#ledger" type="button" role="tab">Ledger</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="monthly-tab" data-bs-toggle="tab" data-bs-target="#monthly" type="button" role="tab">Monthly Report</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="quarterly-tab" data-bs-toggle="tab" data-bs-target="#quarterly" type="button" role="tab">Quarterly Report</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="bytype-tab" data-bs-toggle="tab" data-bs-target="#bytype" type="button" role="tab">Revenue by Type</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="bycustomer-tab" data-bs-toggle="tab" data-bs-target="#bycustomer" type="button" role="tab">Revenue by Customer</button>
            </li>
        </ul>
        <div class="tab-content" id="financialTabsContent">
            <div class="tab-pane fade show active" id="transactions" role="tabpanel">
                <div class="table-container">
                    <h2>Transactions <button class="btn btn-secondary btn-sm btn-export no-print" onclick="exportTableToCSV('transactionTable', 'transactions.csv')">Export to CSV</button></h2>
                    <div class="filter-container no-print">
                        <div class="row g-2">
                            <div class="col-md-3">
                                <label for="typeFilter" class="form-label">Filter by Container Type:</label>
                                <select id="typeFilter" class="form-select"></select>
                            </div>
                            <div class="col-md-3">
                                <label for="dateRange" class="form-label">Filter by Date Range:</label>
                                <input type="text" id="dateRange" class="form-control" placeholder="Select date range">
                            </div>
                            <div class="col-md-3">
                                <label for="customerFilter" class="form-label">Filter by Customer:</label>
                                <select id="customerFilter" class="form-select"></select>
                            </div>
                            <div class="col-md-3">
                                <label for="locationFilter" class="form-label">Filter by Location:</label>
                                <select id="locationFilter" class="form-select"></select>
                            </div>
                        </div>
                    </div>
                    <table class="table table-striped table-hover" id="transactionTable">
                        <thead class="table-dark">
                            <tr><th>Type</th><th>Serial No</th><th>Customer</th><th>Amount</th><th>Date</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <div class="alert alert-info">
                        <strong>Total Revenue: $</strong><span id="totalRevenue">0</span>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="ledger" role="tabpanel">
                <div class="table-container">
                    <h2>Ledger Report <button class="btn btn-secondary btn-sm btn-export no-print" onclick="exportTableToCSV('ledgerTable', 'ledger.csv')">Export to CSV</button></h2>
                    <div class="filter-container no-print">
                        <div class="row g-2">
                            <div class="col-md-3">
                                <label for="typeFilterLedger" class="form-label">Filter by Container Type:</label>
                                <select id="typeFilterLedger" class="form-select"></select>
                            </div>
                        </div>
                    </div>
                    <table class="table table-striped table-hover" id="ledgerTable">
                        <thead class="table-dark">
                            <tr><th>Date</th><th>Type</th><th>Serial No</th><th>Customer</th><th>Amount</th><th>Running Balance</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="tab-pane fade" id="monthly" role="tabpanel">
                <div class="table-container">
                    <h2>Monthly Report <button class="btn btn-secondary btn-sm btn-export no-print" onclick="exportTableToCSV('monthlyTable', 'monthly_report.csv')">Export to CSV</button></h2>
                    <table class="table table-striped table-hover" id="monthlyTable">
                        <thead class="table-dark">
                            <tr><th>Month</th><th>Revenue</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="tab-pane fade" id="quarterly" role="tabpanel">
                <div class="table-container">
                    <h2>Quarterly Report <button class="btn btn-secondary btn-sm btn-export no-print" onclick="exportTableToCSV('quarterlyTable', 'quarterly_report.csv')">Export to CSV</button></h2>
                    <table class="table table-striped table-hover" id="quarterlyTable">
                        <thead class="table-dark">
                            <tr><th>Quarter</th><th>Revenue</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="tab-pane fade" id="bytype" role="tabpanel">
                <h2>Revenue by Container Type</h2>
                <div class="chart-container">
                    <canvas id="revenueByTypeChart"></canvas>
                </div>
            </div>
            <div class="tab-pane fade" id="bycustomer" role="tabpanel">
                <h2>Revenue by Customer</h2>
                <div class="chart-container">
                    <canvas id="revenueByCustomerChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>